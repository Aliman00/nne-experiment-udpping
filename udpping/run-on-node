#!/bin/bash -e

CONTAINER=dreibh/udpping

WORKDIR=/run/shm/test0
rm -rf $WORKDIR
mkdir -p $WORKDIR
echo '{ "node_id": "58", "sync_server": "pioneer.nntb.no", "sync_identity": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC3c5slgEdWW7XzmuNJkDswrd4FhSMGTVSMO7dujSrhP8pqMUDeXuAYsD0Tn6gwitScm30V/T4gxbDxnHokWuuqg6m3aotxvqnxOHdbtlQW9Ho5tqU469JDq7QZYnJmLjSgJ5cQYodEzfLJxQzgpHDzNMa/P224c18+SdhRL7LtYLBMtJLW1cG/aJ6Wlg7H3qzxjKG36YDZ3TRz0sEH+xuHK2VTZENQJ66IC+WUHwSiMpArb6t07r8cNZNv6VLbtIVj3xYO9olu08L0atPeKJjXvPz/6E2qeiFcFzjRlk/LRee1a73VoAPu+RzjFqVt88f5KtQRWdytV1zRSLTpWYsTeY7t8I5/cYzBCviZXygV3IpcoSgppnyKKF2ZSICXsT3QTsdIFVnB95my9bIZmgOk7B0gvF0eOG+UB1wI7jk4Iq7HsAqf9MYojwINiydGHfzsRYEdAuK4eipbKjD7NErqBur6XuxjrAxulVmjFBJLaJz+S2NFkdB6iRCcwHSBNNnYypdyUB5Z/JGx60H38h31oSoaotV4v14Dy4y7jxKAV9c4m9rfOexpRrPZ61yuM2CE9Jv6wn6aJVxkLCvJoOi0s6iOgOTyCLAL+hoLPq+U9zTUUuGPKxhsrmihOqqSCLux73VTspO9Y8P8ZjsRvOm8ym3ZpDHhnh5vKnPfLJCbWw== invalid@example.org", "instances": [ { "measurement_id": "99999", "iccid": "89470000160401348264", "network_id": "99" } ] }' >$WORKDIR/config
# echo '{ "node_id": "70", "sync_server": "pioneer.nntb.no", "sync_identity": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC3c5slgEdWW7XzmuNJkDswrd4FhSMGTVSMO7dujSrhP8pqMUDeXuAYsD0Tn6gwitScm30V/T4gxbDxnHokWuuqg6m3aotxvqnxOHdbtlQW9Ho5tqU469JDq7QZYnJmLjSgJ5cQYodEzfLJxQzgpHDzNMa/P224c18+SdhRL7LtYLBMtJLW1cG/aJ6Wlg7H3qzxjKG36YDZ3TRz0sEH+xuHK2VTZENQJ66IC+WUHwSiMpArb6t07r8cNZNv6VLbtIVj3xYO9olu08L0atPeKJjXvPz/6E2qeiFcFzjRlk/LRee1a73VoAPu+RzjFqVt88f5KtQRWdytV1zRSLTpWYsTeY7t8I5/cYzBCviZXygV3IpcoSgppnyKKF2ZSICXsT3QTsdIFVnB95my9bIZmgOk7B0gvF0eOG+UB1wI7jk4Iq7HsAqf9MYojwINiydGHfzsRYEdAuK4eipbKjD7NErqBur6XuxjrAxulVmjFBJLaJz+S2NFkdB6iRCcwHSBNNnYypdyUB5Z/JGx60H38h31oSoaotV4v14Dy4y7jxKAV9c4m9rfOexpRrPZ61yuM2CE9Jv6wn6aJVxkLCvJoOi0s6iOgOTyCLAL+hoLPq+U9zTUUuGPKxhsrmihOqqSCLux73VTspO9Y8P8ZjsRvOm8ym3ZpDHhnh5vKnPfLJCbWw== invalid@example.org", "instances": [ { "measurement_id": "99998", "iccid": "89470715000003314007", "network_id": "98" }, { "measurement_id": "99997", "iccid": "8947080037001158277", "network_id": "97" } ] }' >$WORKDIR/config
mkdir -p $WORKDIR/results


MONROE_NAMESPACE=$(docker ps --no-trunc -aqf name=monroe-namespace)

docker rm -f test0 >/dev/null 2>&1 || true

sudo docker pull $CONTAINER

echo "Run:"
docker run -d \
   --name test0 \
   --net=container:$MONROE_NAMESPACE \
   --cap-add NET_ADMIN \
   --cap-add NET_RAW \
   --shm-size=1G \
   -v $WORKDIR/results:/monroe/results \
   -v $WORKDIR/config:/monroe/config:ro \
   -v /etc/nodeid:/nodeid:ro \
   $CONTAINER
